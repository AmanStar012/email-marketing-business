<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Marketing Bussiness</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333
    }

    .group-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      align-items: stretch;
      max-width: 1700px;
      margin: 0 auto;
      background: rgba(255, 255, 255, .95);
      border-radius: 24px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, .1);
      overflow: hidden;
      backdrop-filter: blur(10px)
    }

    .container {
      max-width: none;
      margin: 0;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      backdrop-filter: none
    }

    .container[data-group="vidzy"] {
      border-right: 1px solid rgba(0, 0, 0, .08)
    }

    .container .header {
      padding: 20px
    }

    .container .header h1 {
      font-size: 1.6em
    }

    .container .stats-grid {
      gap: 10px;
      margin-top: 18px
    }

    .container .stat-card {
      padding: 12px;
      border-radius: 12px
    }

    .container .stat-number {
      font-size: 1.6em
    }

    .container .main-content {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 18px
    }

    .container .section {
      padding: 18px;
      border-radius: 14px
    }

    .container .upload-zone {
      padding: 24px
    }

    .container .section-title {
      font-size: 1.1em
    }

    .container .right-column {
      margin-top: 0
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: #fff;
      padding: 30px;
      text-align: center;
      position: relative;
      overflow: hidden
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, .1) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: .5
      }

      50% {
        transform: scale(1.05);
        opacity: .8
      }
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
      position: relative;
      z-index: 1
    }

    .header p {
      font-size: 1.1em;
      opacity: .9;
      position: relative;
      z-index: 1
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
      position: relative;
      z-index: 1
    }

    .stat-card {
      background: rgba(255, 255, 255, .15);
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, .2);
      transition: transform .3s ease
    }

    .stat-card:hover {
      transform: translateY(-5px)
    }

    .stat-number {
      font-size: 2.5em;
      font-weight: 700;
      display: block;
      margin-bottom: 5px
    }

    .stat-label {
      font-size: .9em;
      opacity: .9
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 40px
    }

    .section {
      background: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .05);
      border: 1px solid rgba(0, 0, 0, .05);
      transition: transform .3s ease, box-shadow .3s ease
    }

    .section:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, .1)
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 25px;
      gap: 15px
    }

    .section-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      font-weight: 600
    }

    .section-title {
      font-size: 1.4em;
      font-weight: 600;
      color: #2c3e50
    }

    .upload-zone {
      border: 3px dashed #3498db;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
      transition: all .3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden
    }

    .upload-zone:hover {
      border-color: #2980b9;
      background: linear-gradient(135deg, #e3f2fd, #d1e7dd);
      transform: scale(1.02)
    }

    .upload-zone.dragover {
      border-color: #27ae60;
      background: linear-gradient(135deg, #d1e7dd, #c3e6cb);
      transform: scale(1.05)
    }

    .upload-icon {
      font-size: 3.5em;
      margin-bottom: 20px;
      color: #3498db
    }

    .upload-text {
      font-size: 1.1em;
      margin-bottom: 15px;
      color: #2c3e50
    }

    .upload-subtitle {
      font-size: .9em;
      color: #7f8c8d;
      margin-bottom: 20px
    }

    .btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all .3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      position: relative;
      overflow: hidden
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .2), transparent);
      transition: left .5s
    }

    .btn:hover::before {
      left: 100%
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(52, 152, 219, .3)
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
      transform: none
    }

    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954)
    }

    .btn-success:hover {
      box-shadow: 0 8px 25px rgba(39, 174, 96, .3)
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b)
    }

    .btn-danger:hover {
      box-shadow: 0 8px 25px rgba(231, 76, 60, .3)
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #5a6268)
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 12px
    }

    .form-group {
      margin-bottom: 25px
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 14px;
      transition: all .3s ease;
      background: #fff
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, .1)
    }

    .form-control-textarea {
      resize: vertical;
      min-height: 120px;
      font-family: inherit
    }

    .merge-fields {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap
    }

    .merge-field {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all .3s ease;
      border: none;
      font-weight: 500
    }

    .merge-field:hover {
      background: linear-gradient(135deg, #2980b9, #1f4e79);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(52, 152, 219, .3)
    }

    .contacts-preview {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e9ecef
    }

    .contacts-preview h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1em
    }

    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      transition: background .3s ease
    }

    .contact-item:hover {
      background: rgba(52, 152, 219, .05)
    }

    .contact-item:last-child {
      border-bottom: none
    }

    .contact-name {
      font-weight: 600;
      color: #2c3e50
    }

    .contact-email {
      color: #7f8c8d;
      font-size: 14px
    }

    .email-accounts {
      display: grid;
      gap: 20px;
      margin-bottom: 25px
    }

    .email-account {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      transition: all .3s ease
    }

    .email-account.connected {
      border-color: #27ae60;
      background: linear-gradient(135deg, #d1e7dd, #c3e6cb)
    }

    .email-account.disconnected {
      border-color: #e74c3c;
      background: linear-gradient(135deg, #f8d7da, #f5c6cb)
    }

    .active-account {
      border: 2px solid #27ae60 !important;
      background: linear-gradient(135deg, #d1e7dd, #c3e6cb) !important;
      box-shadow: 0 0 15px rgba(39, 174, 96, .3)
    }

    .active-account .account-email {
      font-weight: bold;
      color: #155724
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px
    }

    .account-email {
      font-weight: 600;
      color: #2c3e50
    }

    .account-provider {
      font-size: 12px;
      color: #7f8c8d
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600
    }

    .status-connected {
      background: #d4edda;
      color: #155724
    }

    .status-disconnected {
      background: #f8d7da;
      color: #721c24
    }

    .account-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      flex-wrap: wrap
    }

    .account-toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px
    }

    .account-search {
      flex: 1
    }

    .progress-container {
      padding: 30px;
      background: #fff;
      margin: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .05)
    }


    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      width: 0%;
      transition: width .5s ease;
      position: relative
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .2), transparent);
      animation: shimmer 2s infinite
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%)
      }

      100% {
        transform: translateX(100%)
      }
    }

    .log-area {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 20px;
      border-radius: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.6
    }

    .log-entry {
      margin-bottom: 4px;
      padding: 4px 0;
      border-radius: 4px;
      animation: fadeIn .3s ease
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .log-success {
      color: #2ecc71
    }

    .log-error {
      color: #e74c3c
    }

    .log-warning {
      color: #f39c12
    }

    .log-info {
      color: #3498db
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 25px
    }

    .auto-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 16px;
      margin-top: 15px
    }

    .auto-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .auto-status {
      font-size: 13px;
      color: #444;
      margin-top: 10px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px
    }

    .auto-panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px
    }

    .auto-panel {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 12px
    }

    .auto-panel h4 {
      font-size: 14px;
      color: #2c3e50;
      margin-bottom: 8px
    }

    .mini {
      font-size: 12px;
      color: #666
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid #e9ecef;
      border-radius: 10px
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
      white-space: nowrap
    }

    th {
      background: #f7f8fa;
      font-weight: 700;
      color: #2c3e50
    }

    tr:hover td {
      background: rgba(52, 152, 219, .04)
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700
    }

    .pill-green {
      background: #d4edda;
      color: #155724
    }

    .pill-red {
      background: #f8d7da;
      color: #721c24
    }

    .pill-blue {
      background: #dbeafe;
      color: #1e3a8a
    }

    .pill-gray {
      background: #e5e7eb;
      color: #111827
    }

    @media (max-width:768px) {
      .group-grid {
        grid-template-columns: 1fr
      }

      .container[data-group="vidzy"] {
        border-right: none;
        border-bottom: 1px solid rgba(0, 0, 0, .08)
      }

      .main-content {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr)
      }

      .header h1 {
        font-size: 2em
      }

      .section {
        padding: 20px
      }
    }
  </style>
</head>

<body>
  <div class="group-grid" id="groupGrid">
  <div class="container" data-group="vidzy">
    <div class="header">
      <h1>üöÄ Email Marketing Bussiness</h1>
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number" id="totalSent">0</span>
          <span class="stat-label">Emails Sent</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="successRate">0%</span>
          <span class="stat-label">Success Rate</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="inQueue">0</span>
          <span class="stat-label">In Queue</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="failedCount">0</span>
          <span class="stat-label">Failed</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Upload Contacts -->
        <div class="section">
          <div class="section-header">
            <div class="section-icon">1</div>
            <div class="section-title">Upload Contacts</div>
          </div>
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">üìã</div>
            <div class="upload-text">Drop your CSV file here</div>
            <div class="upload-subtitle">or click to browse</div>
            <input type="file" id="csvInput" accept=".csv" style="display:none;">
            <button class="btn btn-small" onclick="document.getElementById('csvInput').click()">
              üìÅ Choose File
            </button>
          </div>
          <div class="contacts-preview" id="contactsPreview" style="display:none;">
            <h3>üìä Contacts Preview</h3>
            <div class="mini" id="csvCountLabel">CSV Emails: 0</div>
            <div style="height:10px"></div>
            <div id="contactsList"></div>
          </div>
        </div>

        <!-- Email Template + Auto -->
        <div class="section">
          <div class="section-header">
            <div class="section-icon">2</div>
            <div class="section-title">Email Template</div>
          </div>
          <label class="form-label">Brands</label>
          <textarea class="form-control form-control-textarea" id="brandName" rows="3"
            placeholder="Enter one brand per line&#10;Amazon&#10;Flipkart&#10;Myntra">
</textarea>

          <label class="form-label">Subjects</label>
          <textarea class="form-control  form-control-textarea" id="subjectLine" rows="4"
            placeholder="Enter one subject per line">
</textarea>

          <div class="form-group">
            <label class="form-label">Merge Fields</label>
            <div class="merge-fields" id="mergeFields"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Email Content</label>
            <textarea class="form-control form-control-textarea" id="emailContent"
              placeholder="Hey {{firstName}},&#10;&#10;I‚Äôm {{senderName}}, and we‚Äôre currently shortlisting creators for a paid collaboration with {{brandName}}.&#10;&#10;..."></textarea>
          </div>

          <div class="auto-box">
            <div class="auto-row">
              <button class="btn btn-success" id="autoStartBtn">‚è±Ô∏è Start Auto Campaign</button>
              <button class="btn btn-danger" id="autoStopBtn">üõë Stop Auto Campaign</button>
            </div>

            <div class="auto-status" id="autoStatusBox">Auto Status: (loading...)</div>

            <div class="auto-panels">
              <div class="auto-panel">
                <h4>üì® Current Sender (Live)</h4>
                <div id="autoLiveBox" class="mini">‚Äî</div>
              </div>

              <div class="auto-panel">
                <h4>üìä Per-Account Stats</h4>
                <div class="table-wrap">
                  <table id="autoStatsTable">
                    <thead>
                      <tr>
                        <th>Account</th>
                        <th>Sender</th>
                        <th>Sent</th>
                        <th>Failed</th>
                        <th>Last Sent</th>
                      </tr>
                    </thead>
                    <tbody id="autoStatsBody">
                      <tr>
                        <td colspan="5" class="mini">No data</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="mini" style="margin-top:8px" id="autoTotalsMini">‚Äî</div>
              </div>

              <div class="auto-panel">
                <h4>üïí Latest Send Events</h4>
                <div class="log-area" id="autoEventsLog" style="max-height:220px;background:#111827">
                  <div class="log-entry log-info">No events yet</div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Email Accounts -->
        <div class="section">
          <div class="section-header">
            <div class="section-icon">4</div>
            <div class="section-title">Email Accounts</div>
          </div>
          <div class="account-toolbar">
            <input type="text" class="form-control account-search" id="accountSearch" placeholder="Search accounts...">
          </div>
          <div class="email-accounts" id="emailAccounts"></div>

          <div class="action-buttons">
            <button class="btn btn-small" id="saveBtn">üíæ Save Template</button>
            <button class="btn btn-small btn-secondary" id="downloadSample">üì• Sample CSV</button>
          </div>
        </div>
      </div>
    </div>


  </div>

  <script>
    const GROUPS = ["vidzy", "grynow"];

    const state = {
      groups: {
        vidzy: {
          contacts: [],
          emailAccounts: [],
          accountSearch: "",
          stats: { totalSent: 0, successRate: 0, inQueue: 0, failed: 0 }
        },
        grynow: {
          contacts: [],
          emailAccounts: [],
          accountSearch: "",
          stats: { totalSent: 0, successRate: 0, inQueue: 0, failed: 0 }
        }
      }
    };

    function groupEl(id, groupId) {
      return document.getElementById(groupId === "vidzy" ? id : `${id}-${groupId}`);
    }

    function accountGroup(email) {
      const domain = String(email || "").split("@")[1] || "";
      const d = domain.toLowerCase();
      if (d.includes("vidzy")) return "vidzy";
      if (d.includes("grynow")) return "grynow";
      return null;
    }

    class EmailMarketingAPI {
      constructor(baseURL = "") {
        this.baseURL = baseURL;
      }

      async getAccounts() {
        const response = await fetch(`${this.baseURL}/api/accounts`);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Failed to fetch accounts");
        return result.accounts;
      }

      async setAccountStatus(accountId, connected) {
        const response = await fetch(`${this.baseURL}/api/accounts-set-status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accountId, connected })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Failed to set status");
        return result;
      }

      async autoStart(payload) {
        const response = await fetch(`${this.baseURL}/api/auto-start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Failed to start auto campaign");
        return result;
      }

      async autoStop(group) {
        const response = await fetch(`${this.baseURL}/api/auto-stop`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ group })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Failed to stop auto campaign");
        return result;
      }

      async autoStatus(group) {
        const response = await fetch(`${this.baseURL}/api/auto-status?group=${encodeURIComponent(group || "")}`);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Failed to fetch auto status");
        return result;
      }
    }

    const emailAPI = new EmailMarketingAPI();

    function setupGroupContainers() {
      const grid = document.getElementById("groupGrid");
      if (!grid) return;
      const base = grid.querySelector(".container");
      if (!base) return;

      base.dataset.group = "vidzy";
      const title = base.querySelector(".header h1");
      if (title) title.textContent = "Email Marketing - Vidzy";

      const clone = base.cloneNode(true);
      clone.dataset.group = "grynow";
      clone.querySelectorAll("[id]").forEach((el) => {
        el.id = `${el.id}-grynow`;
      });
      clone.querySelectorAll("[onclick]").forEach((el) => {
        const v = el.getAttribute("onclick") || "";
        if (v.includes("csvInput")) {
          el.setAttribute("onclick", v.replace(/csvInput/g, "csvInput-grynow"));
        }
      });
      const cloneTitle = clone.querySelector(".header h1");
      if (cloneTitle) cloneTitle.textContent = "Email Marketing - Grynow";

      grid.appendChild(clone);
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupGroupContainers();
      initializeApp();
    });

    function initializeApp() {
      GROUPS.forEach((groupId) => {
        loadSavedTemplateFromLocalStorage(groupId);
        setupEventListeners(groupId);
        initializeUploadZone(groupId);
        loadAccountsFromBackend(groupId);
        updateMergeFields(groupId, []);
        updateStats(groupId);
        refreshAutoStatus(groupId);
      });

      log("UI ready. Auto available.", "info");

      setInterval(() => {
        GROUPS.forEach((groupId) => {
          refreshAutoStatus(groupId).catch(() => {});
          loadAccountsFromBackend(groupId).catch(() => {});
        });
      }, 5000);
    }

    function setupEventListeners(groupId) {
      const bindings = [
        {
          id: "csvInput",
          event: "change",
          handler: (e) => {
            if (e.target.files && e.target.files[0]) processFile(groupId, e.target.files[0]);
          }
        },
        { id: "autoStartBtn", event: "click", handler: () => startAutoCampaign(groupId) },
        { id: "autoStopBtn", event: "click", handler: () => stopAutoCampaign(groupId) },
        {
          id: "accountSearch",
          event: "input",
          handler: (e) => {
            state.groups[groupId].accountSearch = e.target.value || "";
            renderEmailAccounts(groupId);
          }
        },
        { id: "saveBtn", event: "click", handler: () => saveTemplate(groupId) },
        { id: "downloadSample", event: "click", handler: () => downloadSampleCSV(groupId) }
      ];

      bindings.forEach(({ id, event, handler }) => {
        const el = groupEl(id, groupId);
        if (!el) return;
        el.addEventListener(event, handler);
      });

      ["brandName", "subjectLine", "emailContent"].forEach((id) => {
        const el = groupEl(id, groupId);
        if (!el) return;
        el.addEventListener("input", () => saveTemplateToLocalStorage(groupId));
      });
    }

    function initializeUploadZone(groupId) {
      const uploadZone = groupEl("uploadZone", groupId);
      const csvInput = groupEl("csvInput", groupId);
      if (!uploadZone || !csvInput) return;

      uploadZone.addEventListener("click", (e) => {
        e.preventDefault();
        csvInput.click();
      });
      uploadZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadZone.classList.add("dragover");
      });
      uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
      uploadZone.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadZone.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) processFile(groupId, files[0]);
      });
      csvInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) processFile(groupId, file);
      });
    }

    async function loadAccountsFromBackend(groupId) {
      try {
        const accounts = await emailAPI.getAccounts();
        const filtered = accounts.filter((a) => accountGroup(a.email) === groupId);
        state.groups[groupId].emailAccounts = filtered.map((a, idx) => ({
          ...a,
          provider: `Gmail Account ${a.id}`,
          active: idx === 0
        }));
        renderEmailAccounts(groupId);
      } catch (e) {
        log(`Failed to load accounts (${groupId}): ${e.message}`, "error");
      }
    }

    function processFile(groupId, file) {
      if (!file.name.toLowerCase().endsWith(".csv")) {
        log("Please select a CSV file", "error");
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => parseCSV(groupId, e.target.result);
      reader.onerror = () => log("Error reading file", "error");
      reader.readAsText(file);
      log(`Processing (${groupId}): ${file.name} (${formatFileSize(file.size)})`, "info");
    }

    function parseCSV(groupId, csvData) {
      try {
        const lines = csvData.split("\n").filter((l) => l.trim() !== "");
        if (lines.length < 2) {
          log("CSV must have header + at least 1 row", "error");
          return;
        }

        const headers = parseCSVLine(lines[0]).map((h) => h.replace(/^\uFEFF/, "").trim());
        state.groups[groupId].contacts = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const values = parseCSVLine(line);
          const contact = {};
          headers.forEach((h, idx) => (contact[h] = values[idx] || ""));
          const hasAny = Object.values(contact).some((v) => String(v).trim() !== "");
          if (hasAny) state.groups[groupId].contacts.push(contact);
        }

        if (state.groups[groupId].contacts.length === 0) {
          log("No valid contacts found", "error");
          return;
        }

        displayContacts(groupId);
        updateMergeFields(groupId, headers);
        const countEl = groupEl("csvCountLabel", groupId);
        if (countEl) countEl.textContent = `CSV Emails: ${state.groups[groupId].contacts.length}`;
        updateStatsFromLocalCsvOnly(groupId);
        log(`CSV loaded (${groupId}) - ${state.groups[groupId].contacts.length} contacts`, "success");
      } catch (e) {
        log(`CSV parse error (${groupId}): ${e.message}`, "error");
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;
      let i = 0;

      while (i < line.length) {
        const char = line[i];
        const nextChar = line[i + 1];
        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            current += '"';
            i += 2;
            continue;
          }
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          result.push(current.trim());
          current = "";
        } else {
          current += char;
        }
        i++;
      }

      result.push(current.trim());
      return result.map((f) => f.replace(/^"(.*)"$/, "$1").trim().replace(/$/, ""));
    }

    function displayContacts(groupId) {
      const preview = groupEl("contactsPreview", groupId);
      const list = groupEl("contactsList", groupId);
      if (!preview || !list) return;

      preview.style.display = "block";
      list.innerHTML = "";
      const contacts = state.groups[groupId].contacts;
      const show = contacts.slice(0, 10);

      show.forEach((c) => {
        const item = document.createElement("div");
        item.className = "contact-item";
        const name = getContactName(c);
        const email = getContactEmail(c);
        item.innerHTML = `<div><div class="contact-name">${escapeHtml(name)}</div><div class="contact-email">${escapeHtml(email)}</div></div>`;
        list.appendChild(item);
      });

      if (contacts.length > 10) {
        const more = document.createElement("div");
        more.className = "contact-item";
        more.innerHTML = `<span class="contact-name">...and ${contacts.length - 10} more</span>`;
        list.appendChild(more);
      }
    }

    function getContactName(contact) {
      const firstName = contact.firstName || contact.first_name || contact["First Name"] || contact.fname || "";
      const lastName = contact.lastName || contact.last_name || contact["Last Name"] || contact.lname || "";
      const fullName = contact.name || contact.Name || contact.fullName || contact.full_name || "";
      if (firstName || lastName) return `${firstName} ${lastName}`.trim();
      if (fullName) return fullName;
      const email = getContactEmail(contact);
      if (email) return email.split("@")[0];
      return "Contact";
    }

    function getContactEmail(contact) {
      return contact.email || contact.Email || contact.EMAIL || contact["Email Address"] || contact.email_address || contact.mail || contact.Mail || "";
    }

    function updateMergeFields(groupId, headers) {
      const container = groupEl("mergeFields", groupId);
      if (!container) return;
      container.innerHTML = "";

      ["brandName", "senderName"].forEach((k) => {
        const field = document.createElement("button");
        field.className = "merge-field";
        field.textContent = `{{${k}}}`;
        field.addEventListener("click", () => insertMergeField(groupId, `{{${k}}}`));
        container.appendChild(field);
      });

      (headers || []).forEach((h) => {
        const field = document.createElement("button");
        field.className = "merge-field";
        field.textContent = `{{${h}}}`;
        field.addEventListener("click", () => insertMergeField(groupId, `{{${h}}}`));
        container.appendChild(field);
      });
    }

    function insertMergeField(groupId, field) {
      const textarea = groupEl("emailContent", groupId);
      if (!textarea) return;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + field + text.substring(end);
      textarea.setSelectionRange(start + field.length, start + field.length);
      textarea.focus();
      saveTemplateToLocalStorage(groupId);
    }

    function renderEmailAccounts(groupId) {
      const container = groupEl("emailAccounts", groupId);
      if (!container) return;
      container.innerHTML = "";

      const groupState = state.groups[groupId];
      const query = (groupState.accountSearch || "").trim().toLowerCase();
      const accounts = groupState.emailAccounts.filter((a) => {
        if (!query) return true;
        const email = String(a.email || "").toLowerCase();
        const sender = String(a.senderName || "").toLowerCase();
        return email.includes(query) || sender.includes(query);
      });

      if (accounts.length === 0) {
        container.innerHTML = '<div class="mini">No accounts found</div>';
        return;
      }

      accounts.forEach((account) => {
        const accountDiv = document.createElement("div");
        accountDiv.className = `email-account ${account.connected ? "connected" : "disconnected"} ${account.active ? "active-account" : ""}`;
        accountDiv.innerHTML = `
          <div class="account-header">
            <div>
              <div class="account-email">${account.active ? "Primary" : "Account"}: ${escapeHtml(account.email)}</div>
              <div class="account-provider">Sender: <strong>${escapeHtml(account.senderName || "")}</strong></div>
              ${account.lastError ? `<div class="account-provider" style="color:#b00020;">Last error: ${escapeHtml(account.lastError)}</div>` : ""}
            </div>
            <div class="status-badge ${account.connected ? "status-connected" : "status-disconnected"}">
              ${account.connected ? "Connected" : "Disconnected"}
            </div>
          </div>
          <div class="account-actions">
            <button class="btn btn-small ${account.active ? "btn-success" : "btn-secondary"}" onclick="setActiveAccount('${groupId}', ${account.id})">
              ${account.active ? "Primary" : "Set Primary"}
            </button>
            <button class="btn btn-small ${account.connected ? "btn-danger" : "btn-success"}" onclick="toggleConnection('${groupId}', ${account.id})">
              ${account.connected ? "Disconnect" : "Connect"}
            </button>
          </div>`;
        container.appendChild(accountDiv);
      });
    }

    function setActiveAccount(groupId, accountId) {
      const accounts = state.groups[groupId].emailAccounts;
      accounts.forEach((a) => (a.active = false));
      const selected = accounts.find((a) => a.id === accountId);
      if (selected) selected.active = true;
      renderEmailAccounts(groupId);
    }

    async function toggleConnection(groupId, accountId) {
      const account = state.groups[groupId].emailAccounts.find((a) => a.id === accountId);
      if (!account) return;
      const newStatus = !account.connected;

      try {
        await emailAPI.setAccountStatus(accountId, newStatus);
        account.connected = newStatus;
        if (newStatus) account.lastError = "";
        renderEmailAccounts(groupId);
      } catch (e) {
        log(`Failed to change status (${groupId}): ${e.message}`, "error");
      }
    }

    async function startAutoCampaign(groupId) {
      const groupState = state.groups[groupId];
      if (!Array.isArray(groupState.contacts) || groupState.contacts.length === 0) {
        log(`Upload CSV first (${groupId})`, "error");
        return;
      }

      const brandRaw = groupEl("brandName", groupId)?.value || "";
      const subjectRaw = groupEl("subjectLine", groupId)?.value || "";
      const contentRaw = groupEl("emailContent", groupId)?.value || "";

      const brands = brandRaw.split("\n").map((v) => v.trim()).filter(Boolean);
      const subjects = subjectRaw.split("\n").map((v) => v.trim()).filter(Boolean);
      const bodies = contentRaw.split("---").map((v) => v.trim()).filter(Boolean);

      if (!brands.length || !subjects.length || !bodies.length) {
        log(`Brand, subject, and body are required (${groupId})`, "error");
        return;
      }

      const payload = {
        group: groupId,
        contacts: groupState.contacts.map((c) => normalizeContactEmailKey(c)),
        brandName: brands,
        template: { subject: subjects, content: bodies }
      };

      try {
        const r = await emailAPI.autoStart(payload);
        log(`Auto campaign started (${groupId}): ${r.campaignId}`, "success");
        await refreshAutoStatus(groupId);
      } catch (e) {
        log(`Auto start failed (${groupId}): ${e.message}`, "error");
      }
    }

    async function stopAutoCampaign(groupId) {
      try {
        await emailAPI.autoStop(groupId);
        log(`Auto campaign stopped (${groupId})`, "warning");
        await refreshAutoStatus(groupId);
      } catch (e) {
        log(`Auto stop failed (${groupId}): ${e.message}`, "error");
      }
    }

    async function refreshAutoStatus(groupId) {
      const box = groupEl("autoStatusBox", groupId);
      const liveBox = groupEl("autoLiveBox", groupId);
      const statsBody = groupEl("autoStatsBody", groupId);
      const totalsMini = groupEl("autoTotalsMini", groupId);
      const eventsLog = groupEl("autoEventsLog", groupId);
      if (!box || !liveBox || !statsBody || !totalsMini || !eventsLog) return;

      try {
        const s = await emailAPI.autoStatus(groupId);

        if (!s.campaign) {
          box.innerHTML = 'Auto Status: <strong>None</strong>';
          liveBox.textContent = "-";
          statsBody.innerHTML = '<tr><td colspan="5" class="mini">No data</td></tr>';
          totalsMini.textContent = "-";
          eventsLog.innerHTML = '<div class="log-entry log-info">No events yet</div>';
          updateStatsFromLocalCsvOnly(groupId);
          return;
        }

        const c = s.campaign;
        const total = Number(c.total || 0);
        const cursor = Number(c.cursor || 0);
        const percent = Number(c.percent || (total ? Math.round((cursor / total) * 100) : 0));

        box.innerHTML = `Auto Status: <strong>${escapeHtml(c.status || "")}</strong><br>Campaign: <strong>${escapeHtml(c.id)}</strong><br>Progress: <strong>${cursor}/${total}</strong> (${percent}%)`;

        const progressEl = groupEl("progressFill", groupId);
        if (progressEl) progressEl.style.width = `${Math.min(100, Math.max(0, percent))}%`;

        const live = s.live || null;
        if (live && live.state === "sending" && live.currentEmail) {
          liveBox.innerHTML = `<strong>${escapeHtml(live.currentEmail)}</strong><div class="mini">Sender: ${escapeHtml(live.currentSenderName || "")}</div>`;
        } else {
          liveBox.textContent = live?.state || "-";
        }

        const stats = s.stats || {};
        const totalSent = Number(stats.totalSent || 0);
        const totalFailed = Number(stats.totalFailed || 0);
        const by = stats.byAccount || {};
        const rows = Object.keys(by)
          .map((id) => ({ id, ...by[id] }))
          .sort((a, b) => Number(b.sent || 0) - Number(a.sent || 0));

        if (!rows.length) {
          statsBody.innerHTML = '<tr><td colspan="5" class="mini">No data</td></tr>';
        } else {
          statsBody.innerHTML = rows
            .map((r) => `<tr><td>${escapeHtml(r.email || "")}</td><td>${escapeHtml(r.senderName || "")}</td><td><strong>${Number(r.sent || 0)}</strong></td><td>${Number(r.failed || 0)}</td><td>${r.lastSentAt ? new Date(r.lastSentAt).toLocaleString() : "-"}</td></tr>`)
            .join("");
        }

        totalsMini.textContent = `Total Sent: ${totalSent} | Total Failed: ${totalFailed} | CSV Total: ${total} | Remaining: ${Math.max(0, total - cursor)}`;

        const events = Array.isArray(s.events) ? s.events.slice(-80) : [];
        if (!events.length) {
          eventsLog.innerHTML = '<div class="log-entry log-info">No events yet</div>';
        } else {
          eventsLog.innerHTML = events
            .map((ev) => {
              const ts = ev.ts ? new Date(ev.ts).toLocaleString() : "";
              if (ev.status === "sent") {
                const acceptedCount = Array.isArray(ev.accepted) ? ev.accepted.length : 0;
                const rejectedCount = Array.isArray(ev.rejected) ? ev.rejected.length : 0;
                const responseNote = ev.response ? ` | response: ${escapeHtml(ev.response)}` : "";
                return `<div class="log-entry log-success">[${escapeHtml(ts)}] SENT | ${escapeHtml(ev.to || "")} | accepted: ${acceptedCount} | rejected: ${rejectedCount}${responseNote}</div>`;
              }
              if (ev.status === "failed") {
                return `<div class="log-entry log-error">[${escapeHtml(ts)}] FAILED | ${escapeHtml(ev.to || "")} | ${escapeHtml(ev.error || "")}</div>`;
              }
              return `<div class="log-entry log-info">[${escapeHtml(ts)}] ${escapeHtml(JSON.stringify(ev))}</div>`;
            })
            .join("");
          eventsLog.scrollTop = eventsLog.scrollHeight;
        }

        state.groups[groupId].stats = {
          totalSent,
          failed: totalFailed,
          inQueue: Math.max(0, total - cursor),
          successRate: totalSent + totalFailed > 0 ? Math.round((totalSent / (totalSent + totalFailed)) * 100) : 0
        };
        updateStats(groupId);
      } catch (e) {
        box.textContent = `Auto Status: error - ${e.message}`;
      }
    }

    function updateStatsFromLocalCsvOnly(groupId) {
      const csvTotal = state.groups[groupId].contacts.length || 0;
      state.groups[groupId].stats = { totalSent: 0, successRate: 0, inQueue: csvTotal, failed: 0 };
      updateStats(groupId);
      const progressEl = groupEl("progressFill", groupId);
      if (progressEl) progressEl.style.width = "0%";
    }

    function escapeRegExp(s) {
      return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function normalizeContactEmailKey(contact) {
      const email = getContactEmail(contact);
      return { ...contact, email };
    }

    function saveTemplate(groupId) {
      const template = {
        group: groupId,
        brandName: groupEl("brandName", groupId)?.value || "",
        subject: groupEl("subjectLine", groupId)?.value || "",
        content: groupEl("emailContent", groupId)?.value || "",
        timestamp: new Date().toISOString()
      };
      try {
        localStorage.setItem(`template_${groupId}_${Date.now()}`, JSON.stringify(template));
      } catch (e) {
        log(`Save failed (${groupId}): ${e.message}`, "error");
      }
    }

    function saveTemplateToLocalStorage(groupId) {
      const data = {
        brandRaw: groupEl("brandName", groupId)?.value || "",
        subjectRaw: groupEl("subjectLine", groupId)?.value || "",
        contentRaw: groupEl("emailContent", groupId)?.value || ""
      };
      localStorage.setItem(`last_template_state_${groupId}`, JSON.stringify(data));
    }

    function loadSavedTemplateFromLocalStorage(groupId) {
      const raw = localStorage.getItem(`last_template_state_${groupId}`);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (groupEl("brandName", groupId)) groupEl("brandName", groupId).value = data.brandRaw || "";
        if (groupEl("subjectLine", groupId)) groupEl("subjectLine", groupId).value = data.subjectRaw || "";
        if (groupEl("emailContent", groupId)) groupEl("emailContent", groupId).value = data.contentRaw || "";
      } catch (e) {
        console.warn(`Failed to restore template state (${groupId})`, e);
      }
    }

    function downloadSampleCSV(groupId) {
      const sampleData = `firstName,lastName,email,company
John,Doe,john.doe@example.com,Acme
Jane,Smith,jane.smith@example.com,Tech`;
      const blob = new Blob([sampleData], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `sample_contacts_${groupId}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateStats(groupId) {
      const stats = state.groups[groupId].stats;
      const totalSentEl = groupEl("totalSent", groupId);
      const successRateEl = groupEl("successRate", groupId);
      const inQueueEl = groupEl("inQueue", groupId);
      const failedCountEl = groupEl("failedCount", groupId);
      if (totalSentEl) totalSentEl.textContent = String(stats.totalSent || 0);
      if (successRateEl) successRateEl.textContent = `${stats.successRate || 0}%`;
      if (inQueueEl) inQueueEl.textContent = String(stats.inQueue || 0);
      if (failedCountEl) failedCountEl.textContent = String(stats.failed || 0);
    }

    function log(message, type = "info") {
      const timestamp = new Date().toLocaleTimeString();
      console[type === "error" ? "error" : "log"](`[${timestamp}] ${message}`);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    window.setActiveAccount = setActiveAccount;
    window.toggleConnection = toggleConnection;
  </script>
</body>

</html>
